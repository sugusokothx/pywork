# テニスゲーム実装設計書 (game_tennis_design.md)

## 1. 概要

本ドキュメントは、HTML、CSS、JavaScript を用いて実装された古典的なテニスゲーム（ポン）の設計について記述します。ユーザーがキーボードまたはタッチ操作でパドルを操作し、AIと対戦するシンプルなゲームです。

## 2. ファイル構成

プロジェクトは以下の3つの主要ファイルと1つの要件定義ファイルで構成されています。

- `index.html`: ゲームの構造とユーザーインターフェース（UI）を定義します。
- `style.css`: ゲームの視覚的なスタイルとレイアウトを定義します。
- `script.js`: ゲームの主要なロジック、インタラクション、およびアニメーションを制御します。
- `game_tennis.md`: 本ゲームの初期要件が記述されたドキュメントです。

## 3. HTML (`index.html`) 設計

ゲームの表示と操作に必要な要素を配置します。

- **`<canvas id="game-canvas">`**: ゲームの描画領域となる要素です。JavaScriptによってこの要素内にゲーム要素が描画されます。
- **スコア表示**:
    - `<div id="player1-score">` と `<div id="player2-score">`: それぞれプレイヤー1とプレイヤー2の現在のスコアを表示します。
- **ゲームコントロール**:
    - `<button id="start-button">` と `<button id="stop-button">`: ゲームの開始と終了を制御するためのボタンです。
- **タッチ操作用ボタン**:
    - `<div id="touch-up">` と `<div id="touch-down">`: スマートフォンなどのタッチデバイスでの操作を可能にするための仮想ボタンです。CSSによって、タッチデバイスでのみ表示されるように制御されます。

## 4. CSS (`style.css`) 設計

ゲームの見た目とレスポンシブなレイアウトを定義します。

- **全体的なスタイル**:
    - `body`: 背景色を黒 (`black`)、文字色を白 (`white`) に設定し、画面全体の中央にコンテンツが配置されるようにフレックスボックスを使用します。
- **ゲームコンテナ (`.game-container`)**:
    - キャンバスとスコアボード、コントロールボタンを内包し、中央揃えで配置されます。
- **トップバー (`.top-bar`)**:
    - スコアボードとゲームコントロールボタンを横並びに配置し、スペースを均等に配分します。
- **スコアボード (`.score-board`)**:
    - プレイヤー1とプレイヤー2のスコアを左右に配置し、フォントサイズはビューポートの幅に応じて調整されます（`vw`単位と`max-font-size`を使用）。
- **ゲームキャンバス (`#game-canvas`)**:
    - 背景色を黒、枠線を白に設定し、親要素の幅に合わせて伸縮するようにします。
- **タッチ操作ボタン (`.touch-controls`, `.touch-button`)**:
    - デフォルトでは非表示ですが、メディアクエリ `@media (hover: none) and (pointer: coarse)` を使用して、タッチデバイスでのみ表示されるようにします。
- **レスポンシブデザイン**:
    - `@media (max-width: 600px)`: 画面幅が狭い場合に、トップバーの要素を縦方向に配置し、ボタンのレイアウトを調整します。

## 5. JavaScript (`script.js`) 設計

ゲームの主要なロジックとインタラクションを実装します。

### 5.1. 初期設定

- **DOM要素の取得**: `canvas`, `ctx` (Canvas 2Dコンテキスト), `player1ScoreElem`, `player2ScoreElem`, `startButton`, `stopButton`, `touchUp`, `touchDown` などのHTML要素を取得します。
- **ゲームの定数**: `PADDLE_WIDTH`, `PADDLE_HEIGHT`, `BALL_SIZE`, `PADDLE_SPEED` など、ゲームの挙動を決定する定数を定義します。

### 5.2. ゲームの状態とオブジェクト

ゲームの現在の状態と、ゲーム内の各要素のプロパティを管理します。

- `gameRunning`: ゲームが現在実行中かどうかを示すブーリアンフラグ。
- `animationId`: `requestAnimationFrame` のIDを保持し、アニメーションの停止に使用します。
- `player1`: プレイヤー1のパドルオブジェクト。`x`, `y` (位置), `width`, `height` (サイズ), `dy` (Y方向の移動速度) を持ちます。
- `player2`: AIが操作するプレイヤー2のパドルオブジェクト。`x`, `y`, `width`, `height` を持ちます。
- `ball`: ボールオブジェクト。`x`, `y`, `width`, `height`, `dx`, `dy` (X, Y方向の移動速度) を持ちます。
- `player1Score`, `player2Score`: 各プレイヤーの現在のスコアを保持する変数。

### 5.3. 描画関数

ゲーム要素をキャンバスに描画するための関数群です。

- `drawRect(x, y, w, h, color)`: 指定された位置とサイズ、色で四角形を描画します。パドルやボールの描画に使用されます。
- `drawNet()`: キャンバスの中央に点線のネットを描画します。
- `render()`: ゲームの現在の状態に基づいて、キャンバス全体を再描画します。背景、ネット、パドル、ボールを描画します。

### 5.4. ゲームロジック

ゲームのルールと挙動を制御する主要な関数です。

- `resetGame()`: ゲームを初期状態にリセットします。スコア、パドル、ボールの位置を初期値に戻し、画面を再描画します。
- `update()`: ゲームのフレームごとに呼び出され、以下の処理を行います。
    - **プレイヤー1のパドル移動**: `player1.dy` に基づいてパドルを移動させ、キャンバスの境界内で制限します。
    - **AIの移動ロジック**:
        - ボールがAI側に向かっている場合 (`ball.dx > 0`)、ボールのY座標を追いかけるようにAIパドルを移動させます。`aiSpeed` と `aiTrackingSpeed` でAIの反応速度と最大速度を調整します。
        - ボールがプレイヤー1側にある場合、AIパドルは中央に戻ろうとします。
    - **ボールの移動**: `ball.dx` と `ball.dy` に基づいてボールを移動させます。
    - **壁との衝突判定**: ボールがキャンバスの上下の壁に当たると、`ball.dy` を反転させて跳ね返ります。
    - **パドルとの衝突判定**:
        - ボールがプレイヤー1またはプレイヤー2のパドルに当たると、`ball.dx` を反転させて跳ね返ります。
        - 跳ね返り時に `ball.dy` にランダムな変化を加え、ボールの軌道を予測しにくくします。
        - `ball.dy` の速度が極端にならないように制限を設けます。
    - **得点判定**:
        - ボールが左の壁を越えた場合 (`ball.x < 0`)、プレイヤー2のスコアを1点加算します。
        - ボールが右の壁を越えた場合 (`ball.x + BALL_SIZE > canvas.width`)、プレイヤー1のスコアを1点加算します。
        - 得点が入った後、`resetBallPosition()` を呼び出してボールをリセットします。
- `resetBallPosition()`: 得点が入った後にボールをキャンバスの中央にリセットし、X方向の速度を反転させ、Y方向の速度をランダムに設定します。

### 5.5. ゲームループ

ゲームのアニメーションと更新を継続的に実行します。

- `gameLoop()`: `update()` と `render()` を繰り返し呼び出し、`requestAnimationFrame` を使用してスムーズなアニメーションを実現します。`gameRunning` が `false` になると停止します。

### 5.6. イベントリスナー

ユーザーの入力やUI操作に応答します。

- **開始/終了ボタン**:
    - `startButton` のクリックイベント: `gameRunning` が `false` の場合、`resetGame()` を呼び出し、`gameRunning` を `true` に設定して `gameLoop()` を開始します。
    - `stopButton` のクリックイベント: `gameRunning` が `true` の場合、`gameRunning` を `false` に設定し、`cancelAnimationFrame()` でアニメーションを停止し、`resetGame()` を呼び出します。
- **キーボード操作**:
    - `keydown` イベント: 'w' キーでプレイヤー1のパドルを上に、's' キーで下に移動させます。
    - `keyup` イベント: 'w' または 's' キーが離されたときに、プレイヤー1のパドルの移動を停止します。
- **タッチ操作**:
    - `touchUp` と `touchDown` ボタンの `touchstart` イベント: それぞれプレイヤー1のパドルを上または下に移動させます。`e.preventDefault()` でスクロールなどのデフォルト動作を防止します。
    - `touchend` イベント: タッチが終了したときに、パドルの移動を停止します。

### 5.7. 初期描画

- ページ読み込み時に `render()` を呼び出し、ゲームの初期画面を表示します。

## 6. ゲームフロー

1.  **ページロード**: `index.html` が読み込まれ、`style.css` でスタイルが適用され、`script.js` が実行されます。
2.  **初期描画**: `script.js` の `render()` 関数が呼び出され、黒い背景、白いネット、パドル、ボールが初期位置に描画されます。スコアは0で表示されます。
3.  **ゲーム開始**: ユーザーが「開始」ボタンをクリックすると、`gameRunning` フラグが `true` に設定され、`gameLoop()` が `requestAnimationFrame` によって開始されます。
4.  **ゲームループ**:
    - 各フレームで `update()` が呼び出され、プレイヤーの入力、AIの動き、ボールの移動、衝突判定、得点判定が行われます。
    - その後 `render()` が呼び出され、更新されたゲームの状態がキャンバスに描画されます。
5.  **得点**: ボールが左右の壁を越えると、対応するプレイヤーに1点が加算され、`resetBallPosition()` によってボールが中央にリセットされ、新しい方向で動き出します。
6.  **ゲーム終了**: ユーザーが「終了」ボタンをクリックすると、`gameRunning` フラグが `false` に設定され、`gameLoop` が停止し、ゲームの状態がリセットされます。

## 7. 今後の拡張性

現在の実装を基に、以下の機能拡張が考えられます。

- **AIの難易度調整**: AIの追跡速度や反応速度を調整するオプションを追加する。
- **サウンドエフェクト**: ボールが壁やパドルに当たった際、得点が入った際などに効果音を追加する。
- **ゲームオーバー画面**: どちらかのプレイヤーが特定のスコアに達した際に、ゲームオーバー画面を表示する。
- **複数ラウンド制**: 複数ラウンドをプレイし、最終的な勝者を決定する。
- **ボールの速度変化**: ゲームの進行に応じてボールの速度が徐々に上がるようにする。
- **一時停止機能**: ゲームを一時停止/再開する機能を追加する。
- **プレイヤー2の操作**: AIだけでなく、2人目のプレイヤーが操作できるようにするモードを追加する。
